# HTTP 通信过程

## 一、HTTP 协议

HTTP 协议是一个简单的请求-响应协议，也叫超文本传输协议，在 TCP/IP 协议栈中是运行在 TCP 之上的应用层通信协议。它指定了客户端可能发送给服务器什么样的消息以及得到什么样的响应。

## 二、HTTP 发展历程

HTTP 协议的发展到目前经历了**四个版本阶段**：

- **0.9版本**：仅仅是一个交换信息的无序协议，数据传输仅仅限于文字，且当时并未有固定完整格式。
- **1.0版本**：提出了更加规范的协议格式，当前协议中的请求方法，协议版本等都是在这个版本提出，且支持了各种流媒体资源的传输。
- **1.1版本**：在1.0版本协议格式基础之上增加了更多的请求方法以及头信息，并且更加注重于传输性能以及效率的提升。
- **2.0版本**：仍在修订之中，考虑以前版本协议规范的冗余庞大，因此相较于之前版本做了一次大的跃迁。

## 三、HTTP 协议格式

HTTP 报文由从客户机到服务器的请求和从服务器到客户机的响应构成。

**请求报文格式如下：**

请求行 － 通用信息头 － 请求头 － 实体头 － 报文主体

- **首行**：也叫请求行，包含本次请求的请求方法、URL、协议版本等信息。
- **头部字段**：包含通用头，请求头，实体头，表示请求的各类属性，格式以冒号分割组成的键值对；每组属性之间使用 CR+LF 分隔;
- **空行**：CR+LF，以回车加换行符，作为头部与正文之间的间隔
- **正文**：空行后面的内容都是 Body. 是本次请求提交给服务器的数据实体。

**应答报文格式如下：**

状态行 － 通用信息头 － 响应头 － 实体头 － 报文主体

- **首行**：也叫状态行，表示请求处理结果的状态，包含协议版本、响应状态码、状态码描述。
- **首部字段**：包含通用信息头部，响应头以及实体头部，表示响应的各类属性,
- **空行**：CR+LF，以回车加换行符，作为头部与正文之间的间隔
- **正文**：空行后面的内容都是 Body. 是本次服务器响应给客户端的数据实体。

## 四、HTTP 通信过程

因为 HTTP 协议是在传输层基于 TCP 通信实现，因此 HTTP 也是是基于客户/服务器模式，且面向连接的。

典型的 HTTP 事务处理有如下的过程：

- 搭建 TCP 客户端以及服务端程序，并且建立连接。
- 客户端组织 HTTP 协议格式请求数据，向服务端提出请求。
- 服务端接收请求，并按照 HTTP 协议格式对请求进行解析，并根据请求进行业务处理。
- 服务端业务处理完毕后，按照 HTTP 协议格式组织 HTTP 响应数据，向客户端进行响应。

## 五、HTTP 协议 Connection 头部字段

在 HTTP 的发展历程中，1.0 版本奠定了 HTTP 协议的格式，并且支持了各种流媒体资源的传输，规定了双方的连接方式和连接类型，该版本协议对每一次请求/响应建立并断开一次连接。其特点是简单、易于管理，所以它符合了大家的需要，得到了广泛的应用，而这种通信方式也就是我们所说的短连接。

**短连接：**每一次通信都对应一次 TCP 连接的建立，完成请求/响应的过程，通信完毕后断开连接。优点是简单，易于管理。

但是，HTTP/1.0 版本中，对于互联网最重要的速度和效率，并没有太多的考虑。因此在 HTTP/1.1中 引入了管线化长连接的思想，旨在一次连接建立，完成多个请求的通信，即可以在一次连接中连续发送多个请求，然后按照请求顺序服务端进行响应，进而减少连接建立以及断开的次数，避免 TCP 拥塞控制所带来的传输效率降低。

![img](.\Photo\http.jpg)

**长连接：**一次通信中，建立一个连接，可以连续发送多次请求，服务端按序响应进而减少连接建立以及断开的次数，避免 TCP 拥塞控制所带来的传输效率降低。

**注意：**HTTP/1.1 中的管线化长连接依然不是最优解决方案，因为其中存在队头阻塞问题（若请求1响应较慢，其他的响应也会无法及时到达，必须等到请求1处理完毕后才会响应下一个请求），这个问题在 HTTP/2.0 中得到了解决。

**Connection：**

而在 HTTP 通信中，长短连接的控制通过通用头部字段 **`Connection `** 字段完成。

**`Connection`** 一般用于控制网络连接是否保持打开状态，当前事务结束之后。如果发送的值是 **`keep-alive`**，连接是持久的并且不关闭，从而允许对同一服务器的后续请求完成。

**使用方法：**

```
Connection: keep-alive
Connection: close
```

注意：

**`close `**表示客户端或服务器想要关闭连接。这是 HTTP/1.0 请求的默认值。

**`keep-alive`** 表示客户端想要保持连接处于打开状态。持久连接是 HTTP/1.1 请求的默认连接。

